<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Kani Escape</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <style>
    /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«: ç”»é¢ä¸­å¤®å¯„ã›ã¨ä½™ç™½ãƒªã‚»ãƒƒãƒˆ */
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      background: #f0f0f0; 
    }
    
    /* ã‚²ãƒ¼ãƒ ç”»é¢ã®ç®± */
    #game {
      position: relative;
      width: 360px;
      height: 640px;
      margin: 0 auto;
      background: #cce8ff; /* æ°´è‰²ï¼æµ·ã£ã½ã„ */
      overflow: hidden;
      touch-action: none; 
    }

    /* ã‚«ãƒ‹ */
    #crab {
      position: absolute;
      bottom: 100px; 
      left: 50%;
      transform: translateX(-50%);
      font-size: 40px;
    }

    /* çˆ†å¼¾ï¼ˆè¤‡æ•°ï¼‰ */
    .bomb {
      position: absolute;
      top: -40px;
      left: 160px;
      font-size: 40px;
    }

    /* çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .explosion {
      position: absolute;
      width: 20px;
      height: 20px;
      background: red;
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0.2);
      opacity: 1;
      pointer-events: none;
      animation: boom 0.4s ease-out forwards;
    }

    @keyframes boom {
      0% {
        transform: translate(-50%, -50%) scale(0.2);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(3.0);
        opacity: 0;
      }
    }

    /* ğŸ† ã‚¹ã‚³ã‚¢è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #333;
      font-size: 20px;
      font-weight: bold;
      z-index: 10;
    }
    
    /* ğŸ›‘ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #game-over-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7); 
      color: white;
      display: none; 
      z-index: 20;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    #game-over-screen h2 {
      font-size: 40px;
      margin-bottom: 10px;
    }

    #game-over-screen p {
      font-size: 24px;
      margin-bottom: 30px;
    }

    #game-over-screen button {
      padding: 10px 20px;
      font-size: 20px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #ffcc00;
      color: #333;
      font-weight: bold;
      transition: background 0.2s;
    }
    
    #game-over-screen button:hover {
        background: #ffe066;
    }

    /* ğŸ†• STARTç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #start-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #cce8ff; 
      color: #333;
      z-index: 30; 
      display: flex; 
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    
    #start-screen h1 {
        font-size: 36px;
        margin-bottom: 20px;
        color: navy;
    }
    
    #start-screen p {
        font-size: 18px;
        margin-bottom: 40px;
    }
    
    #start-screen button {
      padding: 15px 30px;
      font-size: 24px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #ffaa00; 
      color: white;
      font-weight: bold;
      box-shadow: 0 4px #cc8800;
      transition: background 0.1s;
    }
    
    #start-screen button:active {
        box-shadow: none;
        transform: translateY(4px);
    }
    
    /* âœ¨ çŒ«ã‚²ãƒƒãƒˆæ™‚ã®ã‚­ãƒ©ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .collect-effect {
      position: absolute;
      width: 30px;
      height: 30px;
      background: #ffd700; 
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0.1);
      opacity: 1;
      pointer-events: none;
      animation: sparkle 0.6s ease-out forwards; 
      box-shadow: 0 0 10px 5px rgba(255, 215, 0, 0.7); 
    }

    @keyframes sparkle {
      0% {
        transform: translate(-50%, -50%) scale(0.1);
        opacity: 1;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.5); 
        opacity: 0.8;
      }
      100% {
        transform: translate(-50%, -50%) scale(0.5); 
        opacity: 0;
      }
    }
    
    /* ğŸ“± ã‚¹ãƒãƒ›ç”¨æ“ä½œãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #controls {
      position: absolute;
      bottom: 0px;
      width: 100%;
      height: 80px; 
      display: flex;
      justify-content: space-around; 
      align-items: center;
      padding: 10px;
      box-sizing: border-box;
      z-index: 15;
      background: #eee; 
      border-top: 2px solid #aaa;
    }
    #controls button {
      width: 45%;
      height: 60px;
      font-size: 30px;
      background: #fff;
      border: 3px solid #333;
      border-radius: 10px;
      cursor: pointer;
      user-select: none; 
      touch-action: manipulation; 
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="score">ç”Ÿãæ®‹ã£ãŸæ™‚é–“: 0.00s</div>
    <div id="crab">ğŸ¦€</div>
    
    <div id="start-screen">
      <h1>Kani Escape</h1>
      <p>æ“ä½œï¼šâ—€/â–¶ ã‚­ãƒ¼ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³</p>
      <button id="start-button">ã¯ã˜ã‚ã‚‹</button>
    </div>
    
    <div id="game-over-screen">
      <h2>GAME OVER</h2>
      <p id="final-score"></p>
      <button onclick="window.location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>
    
    <div id="controls">
      <button id="left-btn">â—€</button>
      <button id="right-btn">â–¶</button>
    </div>
  </div>

  <script>
    const gameWidth = 360;
    const gameHeight = 640;

    const game = document.getElementById('game');
    const crab = document.getElementById('crab');
    const scoreEl = document.getElementById('score');
    
    const gameOverScreen = document.getElementById('game-over-screen');
    const finalScoreEl = document.getElementById('final-score');
    
    // ğŸ†• STARTç”»é¢ã®è¦ç´ ã‚’å–å¾—
    const startScreen = document.getElementById('start-screen');
    const startButton = document.getElementById('start-button');

    gameOverScreen.style.display = 'none';

    // ğŸ†• éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ (ã‚ãªãŸã®æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«åã«ä¿®æ­£æ¸ˆã¿)
    const bgm = new Audio('picopico.mp3'); 
    bgm.loop = true; 
    
    const hitSE = new Audio('bomb.mp3'); 
    const collectSE = new Audio('nyanya.mp3'); 

    let crabX = gameWidth / 2;
    const crabSpeed = 6;
    
    crab.style.left = crabX + 'px';

    const bombs = [];
    let frameCount = 0;
    let leftPressed = false;
    let rightPressed = false;
    let running = false; 

    // ğŸ†• ã‚²ãƒ¼ãƒ é–‹å§‹é–¢æ•°ã‚’å®šç¾©
    function startGame() {
        startScreen.style.display = 'none'; 
        running = true; 
        
        // BGMã‚’å†ç”Ÿé–‹å§‹ (ã‚¹ãƒãƒ›ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼å¯¾ç­–)
        bgm.play().catch(error => {
            console.log("BGMã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        }); 
        
        requestAnimationFrame(loop); 
    }
    
    // çˆ†å¼¾ã‚’1å€‹ç”Ÿæˆã™ã‚‹é–¢æ•°
    function spawnBomb() {
      const el = document.createElement('div');
      el.className = 'bomb';
      
      const isCat = Math.random() < 0.1;
      el.textContent = isCat ? 'ğŸ±' : 'ğŸ’£';
      const type = isCat ? 'cat' : 'bomb';

      const x = Math.random() * (gameWidth - 40);
      const y = -40;
      const speed = isCat ? 4 + Math.random() * 2 : 3 + Math.random() * 1.5; 

      el.style.left = x + 'px';
      el.style.top = y + 'px';
      game.appendChild(el);

      bombs.push({ x, y, speed, el, type });
    }

    // èµ¤ã„å††ã®çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function createExplosion(x, y) {
      const ex = document.createElement('div');
      ex.className = 'explosion';
      ex.style.left = x + 'px';
      ex.style.top = y + 'px';
      game.appendChild(ex);

      setTimeout(() => {
        ex.remove();
      }, 400);
    }

    // âœ¨ çŒ«ã‚²ãƒƒãƒˆæ™‚ã®ã‚­ãƒ©ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function createCollectEffect(x, y) {
      const effect = document.createElement('div');
      effect.className = 'collect-effect';
      effect.style.left = x + 'px';
      effect.style.top = y + 'px';
      game.appendChild(effect);

      setTimeout(() => {
        effect.remove();
      }, 600);
    }


    function loop() {
      if (!running) return;
      frameCount++;

      let score = (frameCount / 60);
      scoreEl.textContent = `ç”Ÿãæ®‹ã£ãŸæ™‚é–“: ${score.toFixed(2)}s`;

      if (leftPressed) {
        crabX -= crabSpeed;
      }
      if (rightPressed) {
        crabX += crabSpeed;
      }

      const minX = 30;
      const maxX = gameWidth - 30;
      if (crabX < minX) crabX = minX;
      if (crabX > maxX) crabX = maxX;

      crab.style.left = crabX + 'px';

      if (frameCount % 60 === 0) {
        spawnBomb();
      }

      for (let i = bombs.length - 1; i >= 0; i--) {
        const bomb = bombs[i];
        bomb.y += bomb.speed;
        bomb.el.style.top = bomb.y + 'px';

        if (bomb.y > gameHeight + 40) {
          bomb.el.remove();
          bombs.splice(i, 1);
          continue;
        }
      }

      const crabRect = crab.getBoundingClientRect();
      const OFFSET = 10; 

      for (let i = bombs.length - 1; i >= 0; i--) {
        const item = bombs[i];
        const itemRect = item.el.getBoundingClientRect();

        const hit =
          crabRect.left + OFFSET < itemRect.right && 
          crabRect.right - OFFSET > itemRect.left && 
          crabRect.top + OFFSET < itemRect.bottom && 
          crabRect.bottom - OFFSET > itemRect.top; 

        if (hit) { // ğŸ’¥ ä¿®æ­£æ¸ˆã¿: if (hit) ã®é–‹ãã‚«ãƒƒã‚³
          if (item.type === 'cat') {
            item.el.remove();
            bombs.splice(i, 1);
            frameCount += 60 * 5; 
            
            console.log("CAT GET! Score +5s!"); 

            // ä¿®æ­£: ã‚¹ãƒãƒ›å¯¾å¿œã®SEå†ç”Ÿã¨ã‚¨ãƒ©ãƒ¼ç„¡è¦–å‡¦ç†
            collectSE.currentTime = 0;
            collectSE.play().catch(e => console.log("SEå†ç”Ÿã‚¨ãƒ©ãƒ¼:", e)); 
            
            createCollectEffect(item.x + item.el.offsetWidth / 2, item.y + item.el.offsetHeight / 2);
            
          } else {
            // çˆ†å¼¾ã«å½“ãŸã£ãŸæ™‚ã®å‡¦ç†
            running = false;
            
            // ä¿®æ­£: BGMåœæ­¢ã¨å·»ãæˆ»ã—
            bgm.pause();
            bgm.currentTime = 0;

            // ä¿®æ­£: ã‚¹ãƒãƒ›å¯¾å¿œã®SEå†ç”Ÿã¨ã‚¨ãƒ©ãƒ¼ç„¡è¦–å‡¦ç†
            hitSE.currentTime = 0;
            hitSE.play().catch(e => console.log("SEå†ç”Ÿã‚¨ãƒ©ãƒ¼:", e)); 

            createExplosion(crabX, crabRect.top); 
            crab.style.display = 'none';

            for (const b of bombs) {
              b.el.remove();
            }

            console.log("HIT!!");
            
            const finalScore = (frameCount / 60).toFixed(2);
            gameOverScreen.style.display = 'flex'; 
            finalScoreEl.textContent = `è¨˜éŒ²: ${finalScore}ç§’`;
            
            return;
          }
        } // ğŸ’¥ ä¿®æ­£æ¸ˆã¿: if (hit) ã®é–‰ã˜ã‚«ãƒƒã‚³
      }
      requestAnimationFrame(loop);
    } 

    // ğŸ†• STARTãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    startButton.addEventListener('click', startGame);
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        leftPressed = true;
      }
      if (e.key === 'ArrowRight') {
        rightPressed = true;
      }
    });

    document.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowLeft') {
        leftPressed = false;
      }
      if (e.key === 'ArrowRight') {
        rightPressed = false;
      }
    });
    
    // ã‚¹ãƒãƒ›æ“ä½œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    const leftBtn = document.getElementById('left-btn');
    const rightBtn = document.getElementById('right-btn');
    
    function startMoveLeft(e) {
      e.preventDefault();
      leftPressed = true;
    }

    function stopMoveLeft() {
      leftPressed = false;
    }

    function startMoveRight(e) {
      e.preventDefault();
      rightPressed = true;
    }

    function stopMoveRight() {
      rightPressed = false;
    }

    leftBtn.addEventListener('mousedown', startMoveLeft);
    leftBtn.addEventListener('mouseup', stopMoveLeft);
    leftBtn.addEventListener('mouseleave', stopMoveLeft);
    leftBtn.addEventListener('touchstart', startMoveLeft);
    leftBtn.addEventListener('touchend', stopMoveLeft);

    rightBtn.addEventListener('mousedown', startMoveRight);
    rightBtn.addEventListener('mouseup', stopMoveRight);
    rightBtn.addEventListener('mouseleave', stopMoveRight);
    rightBtn.addEventListener('touchstart', startMoveRight);
    rightBtn.addEventListener('touchend', stopMoveRight);

  </script>
</body>
</html>